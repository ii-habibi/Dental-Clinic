<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Appointments</title>
</head>

<body>

    <a href="/dashboard">Dashboard</a> <!-- Link to Dashboard -->
    <h1>All Appointments</h1>

    <% appointments.forEach(appointment=> { %>
        <tr id="appointment-<%= appointment.appointment_id %>">
            <td>
                <%= appointment.appointment_id %>
            </td>
            <td>
                <%= appointment.patient_name %>
            </td>
            <td>
                <%= appointment.patient_email %>
            </td>
            <td>
                <%= appointment.patient_phone %>
            </td>
            <td>
                <%= appointment.doctor_id %>
            </td>
            <td>
                <%= appointment.appointment_date %>
            </td>
            <td>
                <%= appointment.appointment_time %>
            </td>
            <td>
                <%= appointment.treatment_type %>
            </td>
            <td>
                <%= appointment.status %>
            </td>
            <td><button class="delete-button" data-id="<%= appointment.appointment_id %>">Delete</button></td>
        </tr>
        <% }) %>

            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                // Form Deletion using AJAX
                $(document).ready(function () {
                    $(document).on('click', '.delete-button', function () {
                        const appointmentId = $(this).data('id'); // Get the appointment ID from the button data attribute
                        const row = $('#appointment-' + appointmentId); // Get the row to remove

                        if (confirm('Are you sure you want to delete this appointment?')) {
                            $.ajax({
                                url: '/dashboard/appointments/delete/' + appointmentId,
                                type: 'DELETE',
                                cache: false,
                                success: function (response) {
                                    console.log("Delete Success:", response);
                                    row.remove(); // Try to remove row dynamically first
                                    alert(response.message);
                                    if (!$('#appointment-' + appointmentId).length) {
                                        location.reload();
                                    }
                                },
                                error: function (xhr) {
                                    console.log("Delete Error:", xhr.responseText); // Log detailed error response
                                    let errorMessage = 'An error occurred while deleting the appointment. Please try again.';
                                    if (xhr.status === 404) {
                                        errorMessage = 'Appointment not found. It may have already been deleted.';
                                    } else if (xhr.status === 500) {
                                        errorMessage = 'Internal Server Error. Please contact support.';
                                    }
                                    alert(errorMessage);
                                }
                            });
                        }
                    });
                });
            </script>

</body>

</html>